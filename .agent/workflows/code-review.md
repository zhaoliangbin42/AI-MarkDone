---
description: 代码审查工作流 - AI 自我审查和交叉审查
---

# 代码审查工作流

> 触发命令: `/review`
> 
> **激活 Skills**: `requesting-code-review` (发起审查), `receiving-code-review` (响应反馈)

## 🚨 Critical Rules (红线规则)

> [!CAUTION]
> 代码审查必须检查以下红线。

| 检查项 | 不通过条件 |
|:-------|:-----------|
| **编译** | `npm run build` 失败 |
| **硬编码** | 存在硬编码颜色/尺寸/路径 |
| **!important** | CSS 中使用 `!important` |
| **console.log** | 使用 `console.log` 而非 `logger` |
| **未处理错误** | `catch` 块为空或只有 `console.error` |

---

## Part A: 自动化检查 (Auto)

### A.1 编译检查

```bash
// turbo
npm run build
```

### A.2 静态扫描

```bash
// turbo
# 检查硬编码颜色
grep -rn "#[0-9a-fA-F]\{3,6\}" src/ --include="*.ts" --include="*.css"

// turbo
# 检查 !important
grep -rn "!important" src/ --include="*.ts" --include="*.css"

// turbo  
# 检查 console.log
grep -rn "console\.log" src/ --include="*.ts"

// turbo
# 注释规范（见 .agent/rules/commenting.md）
# 检查 TODO/FIXME（发布前应清零；开发阶段也必须可追踪）
grep -rn "TODO\|FIXME" src/ --include="*.ts"

// turbo
# TODO/FIXME 格式检查：必须包含 owner，如 TODO(name):
rg -n "//\\s*(TODO|FIXME)(?!\\([^)]+\\):)" -P src --glob "*.ts"

// turbo
# 指令型注释必须带理由（推荐用 `-- reason`）
rg -n "//\\s*@ts-expect-error(?!.*--)" -P src --glob "*.ts"
rg -n "//\\s*eslint-disable-next-line(?!.*--)" -P src --glob "*.ts"
```

---

## Part B: 深度审查 (Think Deeply)

> [!IMPORTANT]
> **思考预算**: 使用 `ultrathink` (~32k tokens) 进行深度代码审查。

### B.1 功能正确性

```
请 ultrathink 审查代码的功能正确性：

1. **需求覆盖**: 代码是否完整实现了需求？
2. **边界处理**: 所有边界条件都处理了吗？
3. **错误路径**: 错误情况有合理的处理吗？
4. **并发安全**: 有竞态条件的风险吗？
```

### B.2 代码质量

| 维度 | 审查标准 |
|:-----|:---------|
| **命名** | 变量/函数名是否清晰表达意图？ |
| **复杂度** | 单个函数是否过于复杂（>50行）？ |
| **重复** | 是否有可抽取的重复代码？ |
| **注释** | 复杂逻辑是否有必要的注释？ |
| **耦合** | 模块间耦合是否合理？ |

### B.3 安全性检查

> [!WARNING]
> 来自 davila7/claude-code-templates 的安全检查项

| 检查项 | 标准 |
|:-------|:-----|
| 敏感信息 | 无硬编码 API Key / 密码 |
| 用户输入 | 所有外部输入都有验证 |
| DOM 操作 | 有空值检查 |
| 异步操作 | 有错误处理和超时保护 |

### B.4 性能检查

| 检查项 | 问题信号 |
|:-------|:---------|
| **算法** | O(n²) 或更差的时间复杂度 |
| **DOM 查询** | 循环内频繁查询 DOM |
| **事件监听** | 未正确清理事件监听器 |
| **内存** | 潜在的内存泄漏（闭包、大对象） |

### B.5 一致性检查

```
检查是否遵循项目现有模式：

1. **日志格式**: 是否使用 `[ModuleName]` 前缀？
2. **错误处理**: 是否遵循 try-catch 模式？
3. **样式**: 是否使用 `--aimd-*` Token？
4. **文件结构**: 是否放在正确的目录？
```

---

## Part C: 审查报告

### C.1 报告模板

```markdown
## 代码审查报告

**审查范围**: [文件列表]
**审查日期**: [日期]

### 📊 总体评估

| 维度 | 评分 | 说明 |
|:-----|:-----|:-----|
| 功能正确性 | ⭐⭐⭐⭐⭐ | ... |
| 代码质量 | ⭐⭐⭐⭐☆ | ... |
| 安全性 | ⭐⭐⭐⭐⭐ | ... |
| 性能 | ⭐⭐⭐⭐☆ | ... |

### ✅ 优点
- [优点1]
- [优点2]

### ⚠️ 建议改进 (可选)
- [ ] [建议1] — 优先级: 低
- [ ] [建议2] — 优先级: 中

### 🔴 必须修复 (如有)
- [ ] [问题1] — 原因: ...
- [ ] [问题2] — 原因: ...

### 🧪 测试建议
- [测试场景1]
- [测试场景2]
```

---

## Part D: 交叉审查 (Multi-Agent)

> [!TIP]
> 来自 davila7/claude-code-templates 的最佳实践：
> 关键代码可使用新对话让另一个 AI 实例审查，获得更客观视角。

### D.1 适用场景

| 场景 | 是否需要交叉审查 |
|:-----|:-----------------|
| 核心架构变更 | ✅ 强烈建议 |
| 安全敏感代码 | ✅ 强烈建议 |
| 性能关键路径 | ✅ 建议 |
| 普通功能代码 | ❌ 不需要 |

### D.2 交叉审查流程

```
1. 在新对话中提供代码变更
2. 请求 "ultrathink 审查这段代码"
3. 整合两次审查的建议
4. 解决冲突意见
```

---

## Part E: 本项目特定检查

### E.1 平台适配检查

| 检查项 | 标准 |
|:-------|:-----|
| ChatGPT 兼容 | 使用 `adapter.getChatGPTSelector()` |
| Gemini 兼容 | 使用 `adapter.getGeminiSelector()` |
| 新增接口 | 已更新 `ADAPTER_CONTRACT.md` |

### E.2 Shadow DOM 检查

| 检查项 | 标准 |
|:-------|:-----|
| 样式隔离 | UI 组件使用 Shadow DOM |
| Token 使用 | 只使用 `--aimd-*` 语义 Token |
| 选择器范围 | 选择器只在 Shadow Root 内生效 |

---

## ✅ 审查通过标准

| 类别 | 必须通过 |
|:-----|:---------|
| 🔴 红线规则 | 全部通过 |
| 🟡 建议改进 | 可暂缓，但应记录 |
| 🟢 优化建议 | 可忽略 |

```
审查结论:
- [ ] ✅ 通过 — 可以合并
- [ ] ⚠️ 有条件通过 — 需要小修改
- [ ] ❌ 不通过 — 需要重做
```
