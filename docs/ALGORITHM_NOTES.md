# 算法复盘笔记

> 本文档记录项目中有趣的算法实现和问题解决思路，供后续复盘参考。

---

## ChatGPT 未渲染公式的下划线修复

### 问题描述

ChatGPT 在渲染行内 LaTeX 公式时，偶尔会出现渲染失败的情况。当公式未被正确渲染为 KaTeX 时，原始 LaTeX 代码会被当做普通 Markdown 处理。

**核心问题**：LaTeX 中的下划线 `_` 与 Markdown 的斜体语法 `_..._` 冲突。

```
原始 LaTeX:  $(\mathbf{F}_{\mathrm{RF}}, \mathbf{F}_{\mathrm{BB}})$
                    ↓ ChatGPT Markdown 解析器（公式渲染失败）
HTML 输出:   $(\mathbf{F}<em>{\mathrm{RF}}, \mathbf{F}</em>{\mathrm{BB}})$
                    ↓ AI-MarkDone 提取时识别 <em> 为斜体
最终输出:   $(\mathbf{F}*{\mathrm{RF}}, \mathbf{F}*{\mathrm{BB}})$  ← 公式损坏！
```

### 难点分析

1. **简单情况**：`<em>` 完全在公式内部 → 直接替换为下划线
2. **复杂情况**：`<em>` 跨越多个公式边界

```html
<!-- 复杂案例：<em> 跨越了两个公式 -->
$\Sigma<em>1}$ 的维度为 $N</em>{s}$
```

Markdown 的 `_..._` 配对规则是**贪婪的**，它不关心 `$` 边界，只找最近的 `_` 对。这导致原本在两个公式内的两个 `_` 被错误配对成一个 `<em>`。

### 解决思路

**第一版方案（失败）**：基于 DOM 位置判断

- 计算 `<em>` 元素在文本中的位置
- 判断是否在 `$...$` 区间内
- **问题**：无法处理跨边界的 `<em>`

**第二版方案（成功）**：基于文本处理的状态机

核心洞察：不要尝试判断 `<em>` 是否"完整地在公式内"，而是**重新解析整个文本**，基于 `$` 边界决定如何处理。

### 算法实现

```
输入: HTML 字符串（包含 <em> 标签和 $ 符号）
输出: 修复后的 HTML 字符串

Step 1: 预处理
   将所有 <em>text</em> 替换为标记 §EM_START§text§EM_END§
   
Step 2: 状态机遍历
   初始状态: inFormula = false
   
   遍历字符串的每个位置 {
       如果遇到 '$$': 跳过（行间公式边界）
       如果遇到 '$':  切换 inFormula 状态
       如果遇到 §EM_START§...§EM_END§:
           如果 inFormula:
               输出 _text_（还原为下划线）
           否则:
               输出 <em>text</em>（保留为斜体）
       否则:
           原样输出
   }

Step 3: 将结果写回 DOM
```

### 关键设计决策

| 决策 | 理由 |
|:----|:----|
| 使用 `§` 作为标记 | 几乎不会出现在数学公式或正常文本中 |
| 文本处理而非 DOM 操作 | 避免复杂的位置计算，一次遍历解决问题 |
| 以块级元素为隔离单元 | 未闭合的 `$` 不会影响其他段落 |
| 跳过已渲染的 KaTeX | 避免重复处理正确渲染的公式 |

### 时间复杂度

- **时间**: O(n)，单次遍历 HTML 字符串
- **空间**: O(n)，存储结果字符串

### 代码位置

- 函数: `enhanceUnrenderedMath()`
- 文件: `src/content/parsers/math-extractor.ts`
- 调用点: `src/content/parsers/markdown-parser.ts` (仅 ChatGPT 平台)

### 测试用例

| 输入 | 期望输出 | 场景 |
|:----|:--------|:----|
| `$a<em>1</em>$` | `$a_1_$` | 简单情况 |
| `$\Sigma<em>1}$ 的维度为 $N</em>{s}$` | `$\Sigma_1}$ 的维度为 $N_{s}$` | 跨边界情况 |
| `正常<em>斜体</em>` | `正常<em>斜体</em>` | 公式外保持不变 |

---

*待补充更多算法笔记...*
