# AI-MarkDone 全插件审查框架（大项）

> 目标：定义全插件范围内的审查主干，作为后续“分项计划 + 分项 checklist”的母版。  
> 范围：Chrome MV3 / Firefox MV2，覆盖代码、运行时行为、数据生命周期与发布链路。

---

## 1. 平台适配与消息边界

### 1.1 范围
- `src/content/adapters/**`
- `src/background/**`
- `src/content/index.ts`
- 与 runtime message 相关的桥接层

### 1.2 关键风险
- 消息协议松散（`any`/弱校验）导致行为漂移或潜在注入面扩大。
- 多平台 DOM 差异导致功能失效、重复注入、监听泄漏。

### 1.3 必审点
- 消息类型收敛（请求/响应 schema、未知 action 拒绝策略）。
- sender/source 边界校验与最小权限原则。
- 各平台适配器的选择器稳定性与 fallback 逻辑。

### 1.4 验收标准
- 消息边界有统一 contract 且落到代码。
- 平台切换/升级时核心功能不回退（有回归证据）。

---

## 2. 渲染与解析链路（Markdown/Math/Code）

### 2.1 范围
- `src/content/parsers/**`
- `src/renderer/**`
- `src/content/features/re-render.ts`

### 2.2 关键风险
- 解析器边界不清导致错误内容渲染或性能退化。
- HTML 注入面与 sanitize 边界不一致。

### 2.3 必审点
- 输入->AST->渲染输出路径一致性与异常回退策略。
- LaTeX/代码块/表格等特殊内容的精度与性能。
- 渲染缓存策略、重复渲染抖动与内存增长。

### 2.4 验收标准
- 高风险样本（长文本、混排、噪声）稳定渲染。
- sanitize 策略可审计，关键 sink 可追踪。

---

## 3. 书签与数据文件系统（已完成首轮）

### 3.1 范围
- `src/bookmarks/**`
- `storage.local` 持久化模型、导入导出、文件夹树

### 3.2 当前状态
- 已完成一轮深度审查与修复（并发写入、判重、可见性、回退策略、roundtrip）。

### 3.3 后续维护重点
- 事务边界透明化（非 ACID 场景的恢复策略）。
- 长期回归套件持续纳入 CI。

---

## 4. 导出/导入与备份恢复

### 4.1 范围
- 导入导出 UI 与数据格式兼容逻辑
- 历史格式兼容（旧版数组格式/新版封装格式）

### 4.2 关键风险
- 版本迁移时字段丢失或语义变化。
- 大文件导入造成部分成功、提示不清、状态不一致。

### 4.3 必审点
- 版本字段与向后兼容协议。
- 失败分类与用户可理解提示。
- 大文件/异常文件/边界文件处理。

### 4.4 验收标准
- 可重复 roundtrip（导出->导入）一致。
- 异常输入不会污染现有数据。

---

## 5. 设置系统与配置生命周期

### 5.1 范围
- `src/settings/SettingsManager.ts`
- `src/utils/i18n.ts`
- `storage.sync` / `storage.local` 角色边界

### 5.2 关键风险
- 双源配置导致状态漂移（如语言、行为开关）。
- 迁移逻辑不幂等导致升级后异常。

### 5.3 必审点
- 配置 schema、默认值、迁移顺序与回滚。
- sync/local 职责分离与数据体量约束。

### 5.4 验收标准
- 首次安装、升级、降级路径行为一致。
- 配置读写具备可追踪与可恢复性。

---

## 6. UI 组件与交互状态管理

### 6.1 范围
- 大型组件（尤其面板类）与通用组件层
- 事件监听、弹窗、通知、键盘交互

### 6.2 关键风险
- 单文件过大导致回归难以控制。
- 交互状态耦合，出现闪烁、错位、事件泄漏。

### 6.3 必审点
- 组件职责拆分与状态边界。
- 事件订阅/反订阅完整性。
- 高频操作（筛选、批量操作）的渲染策略。

### 6.4 验收标准
- 关键组件可测（单元/集成）且行为可预测。
- 无明显重复渲染、闪烁、泄漏。

---

## 7. 安全基线与日志治理

### 7.1 范围
- DOM 注入点、消息边界、权限使用、日志输出

### 7.2 关键风险
- `innerHTML` 动态注入误用导致 XSS 面扩大。
- 生产日志过量，泄漏上下文或影响性能。

### 7.3 必审点
- 关键 sink 分级与白名单策略。
- 日志等级按环境控制，敏感信息脱敏。

### 7.4 验收标准
- 高风险 sink 有明确防线与回归用例。
- 生产日志策略可审计、可切换。

---

## 8. 性能与稳定性（运行时）

### 8.1 范围
- 内容脚本注入、观察器、批量操作、重绘路径

### 8.2 关键风险
- 页面复杂场景下 CPU 升高、卡顿、掉帧。
- 批量操作触发抖动与状态竞争。

### 8.3 必审点
- 热路径性能预算（解析、渲染、批处理）。
- 防抖/节流/合并刷新策略是否统一。

### 8.4 验收标准
- 压测数据下可用性稳定（无长时间卡死）。
- 关键操作响应时间在可接受阈值内。

---

## 9. 测试体系与质量门禁

### 9.1 范围
- `tests/**`
- 单元/集成/回归矩阵
- CI 门禁策略

### 9.2 关键风险
- 仅靠定向绿，缺失全量门禁导致回归漏检。
- 夹具与真实协议漂移，测试失真。

### 9.3 必审点
- 测试分层（smoke/core/full）与触发策略。
- 高价值回归套件纳入强制门禁。

### 9.4 验收标准
- 关键路径测试稳定绿。
- 每个高风险修复都有回归证据。

---

## 10. 跨浏览器兼容与发布工程

### 10.1 范围
- `manifest.chrome.json`
- `manifest.firefox.json`
- build/postbuild/release 打包流程

### 10.2 关键风险
- Chrome/Firefox API 差异导致行为分叉。
- 发布工序缺少自动校验导致产物偏差。

### 10.3 必审点
- API 兼容层一致性（action/browserAction、storage 语义差异）。
- 打包产物完整性（资源、locale、manifest 字段）。

### 10.4 验收标准
- 双平台核心功能一致。
- 发布前检查可自动执行且可追溯。

---

## 11. 文档与变更治理

### 11.1 范围
- `README*`、`docs/**`、`CHANGELOG.md`
- 规则文档与开发流程文档

### 11.2 关键风险
- 代码已变更但文档未更新，导致误操作。
- 审查结论无法沉淀为长期机制。

### 11.3 必审点
- 关键行为变更是否同步到文档与 changelog。
- 审查框架、计划、证据是否可复用。

### 11.4 验收标准
- 文档与实现一致，变更可追溯。
- 新成员可基于文档复现审查流程。

---

## 下一步（暂不执行，仅占位）

1. 按本框架为每个大项生成独立“审查计划 + checklist”。  
2. 每项计划包含：代码范围、风险级别、验证命令、退出标准、证据模板。  
3. 采用分批执行：先安全/边界，再核心链路，再兼容/发布。
