import { Folder, FolderTreeNode } from '../storage/types';
import { FolderStorage } from '../storage/FolderStorage';
import { TreeBuilder } from '../utils/tree-builder';
import { PathUtils } from '../utils/path-utils';
import { logger } from '../../utils/logger';
import { Icons } from '../../assets/icons';
import { DesignTokens } from '../../utils/design-tokens';

/**
 * Theme colors for modal
 */
interface ModalTheme {
    surface: string;
    onSurface: string;
    border: string;
    borderLight: string;
    hover: string;
    selected: string;
    selectedHover: string;
    selectedAccent: string; // Left border for selected items
    primary: string;
    primaryHover: string;
    primaryForeground: string;
    secondary: string;
    secondaryHover: string;
    secondaryForeground: string;
    danger: string;
    textPrimary: string;
    textSecondary: string;
    textMuted: string;
    infoSurface: string;
    infoBorder: string;
    radius: string;
}

const lightTheme: ModalTheme = {
    surface: '#FFFFFF',
    onSurface: '#1C1B1F',
    border: '#E5E7EB',        // var(--gray-200)
    borderLight: '#F3F4F6',   // var(--gray-100)
    hover: '#F9FAFB',         // var(--gray-50)
    selected: '#EFF6FF',      // var(--primary-50)
    selectedHover: '#DBEAFE', // var(--primary-100)
    selectedAccent: '#2563EB', // var(--primary-600)
    primary: '#3B82F6',       // var(--primary-500)
    primaryHover: '#2563EB',  // var(--primary-600)
    primaryForeground: '#FFFFFF',
    secondary: '#F3F4F6',     // var(--gray-100)
    secondaryHover: '#E5E7EB', // var(--gray-200)
    secondaryForeground: '#4B5563', // var(--gray-600)
    danger: '#EF4444',
    textPrimary: '#111827',   // var(--gray-900)
    textSecondary: '#6B7280', // var(--gray-500)
    textMuted: '#9CA3AF',     // var(--gray-400)
    infoSurface: '#EFF6FF',   // var(--primary-50)
    infoBorder: '#BFDBFE',    // var(--primary-200)
    radius: '12px'
};

const darkTheme: ModalTheme = {
    surface: '#1F2937',       // var(--gray-800) - MATCHES PANEL
    onSurface: '#F9FAFB',     // var(--gray-50)
    border: '#374151',        // var(--gray-700) - MATCHES PANEL
    borderLight: '#4B5563',   // var(--gray-600)
    hover: '#374151',         // var(--gray-700) - MATCHES PANEL
    selected: 'rgba(59, 130, 246, 0.2)', // primary-500 @ 20% - MATCHES PANEL
    selectedHover: 'rgba(59, 130, 246, 0.3)', // primary-500 @ 30%
    selectedAccent: '#2563EB', // var(--primary-600) - MATCHES PANEL
    primary: '#3B82F6',       // var(--primary-500)
    primaryHover: '#2563EB',  // var(--primary-600)
    primaryForeground: '#FFFFFF',
    secondary: '#374151',     // var(--gray-700)
    secondaryHover: '#4B5563', // var(--gray-600)
    secondaryForeground: '#F9FAFB', // var(--gray-50)
    danger: '#EF4444',
    textPrimary: '#F9FAFB',   // var(--gray-50) - MATCHES PANEL
    textSecondary: '#9CA3AF', // var(--gray-400)
    textMuted: '#6B7280',     // var(--gray-500)
    infoSurface: 'rgba(59, 130, 246, 0.1)', // primary-500 @ 10%
    infoBorder: 'rgba(59, 130, 246, 0.2)',  // primary-500 @ 20%
    radius: '12px'
};

/**
 * Get current theme based on dark mode
 */
function getTheme(): ModalTheme {
    // ✅ Use DesignTokens for consistent detection across ChatGPT & Gemini
    const isDark = DesignTokens.isDarkMode();
    return isDark ? darkTheme : lightTheme;
}

/**
 * Create style string from object
 */
function styleToString(styles: Record<string, string | number>): string {
    return Object.entries(styles)
        .map(([key, value]) => {
            // Convert camelCase to kebab-case
            const kebabKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();
            return `${kebabKey}: ${value}`;
        })
        .join('; ');
}

/**
 * Unified Bookmark Save Modal
 * Combines title editing and folder selection in one modal
 * Pattern: Notion-style inline editing + VS Code tree view
 */
export class BookmarkSaveModal {
    private overlay: HTMLElement | null = null;
    private modal: HTMLElement | null = null;

    // State
    private folders: Folder[] = [];
    private selectedPath: string | null = null;
    private expandedPaths: Set<string> = new Set();
    private title: string = '';
    private titleValid: boolean = true;
    private currentMode: 'create' | 'edit' | 'folder-select' = 'create';

    // Callbacks
    private onSave: ((title: string, folderPath: string) => void) | null = null;
    private escKeyHandler: ((e: KeyboardEvent) => void) | null = null;

    // Event listener management (AbortController pattern - Web standard)
    private abortController: AbortController | null = null;

    /**
     * Show save modal
     */
    async show(options: {
        mode?: 'create' | 'edit' | 'folder-select';
        defaultTitle?: string;
        lastUsedFolder?: string;
        currentFolder?: string; // For edit mode
        bookmarkCount?: number; // For folder-select mode
        onSave?: (title: string, folderPath: string) => void;
        onFolderSelect?: (folderPath: string | null) => void;
    }): Promise<string | null | undefined | void> {
        const mode = options.mode || 'create';
        this.currentMode = mode;

        if (mode === 'folder-select') {
            // Folder selection mode for batch move - returns selected path
            return this.showFolderSelectMode(options);
        }

        // Create AbortController for this modal instance (Web standard pattern)
        this.abortController = new AbortController();

        this.onSave = options.onSave || null;
        this.title = options.defaultTitle || '';

        // Use currentFolder for edit mode, lastUsedFolder for create mode
        // Load folders
        this.folders = await FolderStorage.getAll();
        logger.debug(`[BookmarkSaveModal] Loaded ${this.folders.length} folders`);

        // Validate and set selected path
        let candidatePath = options.currentFolder || options.lastUsedFolder || null;

        // Check if candidate path still exists in folder tree
        if (candidatePath) {
            const pathExists = this.folders.some(f => f.path === candidatePath);
            if (!pathExists) {
                logger.warn(`[BookmarkSaveModal] Last used folder "${candidatePath}" no longer exists`);
                candidatePath = null;
            }
        }

        // If no valid candidate, use first folder (if any)
        if (!candidatePath && this.folders.length > 0) {
            candidatePath = this.folders[0].path;
            logger.info(`[BookmarkSaveModal] Using first folder: ${candidatePath}`);
        }

        this.selectedPath = candidatePath;

        // Auto-expand folder path
        if (this.selectedPath) {
            this.expandPathToFolder(this.selectedPath);
        }

        // Create overlay (NO Shadow DOM for better compatibility)
        this.overlay = document.createElement('div');
        this.overlay.className = 'bookmark-save-modal-overlay';
        this.overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);  /* Keep for overlay */
            backdrop-filter: blur(4px);
            z-index: 2147483647;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        `;

        // Create modal
        this.modal = this.createModal();
        this.overlay.appendChild(this.modal);

        // Add to body
        document.body.appendChild(this.overlay);

        // Click outside to close (use signal for automatic cleanup)
        this.overlay.addEventListener('click', (e) => {
            if (e.target === this.overlay) {
                this.hide();
            }
        }, { signal: this.abortController.signal });

        // ESC key to close
        this.escKeyHandler = (e: KeyboardEvent) => {
            if (e.key === 'Escape') {
                this.hide();
            }
        };
        document.addEventListener('keydown', this.escKeyHandler);

        // Render folder tree
        this.renderFolderTree();

        // CRITICAL: Update Save button state after rendering tree
        // This enables the button if selectedPath is already set (lastUsedFolder)
        this.updateSaveButtonState();

        // Update header text based on mode
        const headerText = mode === 'edit' ? 'Edit Bookmark' : 'Save Bookmark';
        const header = this.modal.querySelector('.save-modal-header h2');
        if (header) {
            header.textContent = headerText;
        }

        // Focus title input
        setTimeout(() => {
            const titleInput = this.modal?.querySelector('.title-input') as HTMLInputElement;
            if (titleInput) {
                titleInput.select(); // Select all text for easy editing
            }
        }, 100);

        logger.info('[BookmarkSaveModal] Modal shown');
    }

    private updateSaveButtonState(): void {
        const saveBtn = this.modal?.querySelector('.save-modal-btn-save') as HTMLButtonElement;
        if (!saveBtn) return;

        const titleInput = this.modal?.querySelector('.title-input') as HTMLInputElement;
        const title = titleInput?.value?.trim() || '';

        // Disable save button if:
        // 1. No folders exist in the tree (must create folder first)
        // 2. No folder is selected
        // 3. Title is empty
        const hasNoFolders = this.folders.length === 0;
        const noFolderSelected = !this.selectedPath;
        const noTitle = !title;

        const shouldDisable = hasNoFolders || noFolderSelected || noTitle;

        saveBtn.disabled = shouldDisable;

        // Update button appearance
        if (shouldDisable) {
            saveBtn.style.opacity = '0.5';
            saveBtn.style.cursor = 'not-allowed';
        } else {
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
        }

        // Log state for debugging
        if (hasNoFolders) {
            logger.debug('[BookmarkSaveModal] Save disabled: No folders exist');
        } else if (noFolderSelected) {
            logger.debug('[BookmarkSaveModal] Save disabled: No folder selected');
        } else if (noTitle) {
            logger.debug('[BookmarkSaveModal] Save disabled: No title');
        }
    }

    /**
 * Hide and cleanup modal
 */
    hide(): void {
        // 1. Abort all event listeners (one line - Web standard!)
        this.abortController?.abort();
        this.abortController = null;

        // 2. Remove DOM
        if (this.overlay && this.overlay.parentNode) {
            this.overlay.remove();
        }

        // 3. Remove ESC key listener (not managed by AbortController)
        if (this.escKeyHandler) {
            document.removeEventListener('keydown', this.escKeyHandler);
            this.escKeyHandler = null;
        }

        // 4. Clear all state to prevent memory leaks
        this.overlay = null;
        this.modal = null;
        this.folders = [];
        this.selectedPath = null;
        this.expandedPaths.clear();
        this.title = '';
        this.titleValid = true;
        this.onSave = null;

        logger.info('[BookmarkSaveModal] Modal cleaned up');
    }

    /**
     * Create modal structure with dynamic theme
     */
    private createModal(): HTMLElement {
        // Use helper function for theme detection
        const theme = getTheme();

        const modal = document.createElement('div');
        modal.className = 'bookmark-save-modal';

        // Apply theme colors directly
        modal.style.cssText = `
            position: relative;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            background: ${theme.surface} !important;
            color: ${theme.onSurface};
            border-radius: ${theme.radius};
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2), 0 1px 18px rgba(0, 0, 0, 0.12);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.2s ease-out;
        `;

        // Stop propagation on modal content
        modal.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        modal.innerHTML = `
            <style>
                /* Minimal CSS - Only for what inline styles cannot do */
                
                /* Animations */
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-20px) scale(0.95);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }

                /* Box sizing */
                .bookmark-save-modal * {
                    box-sizing: border-box;
                }
                
                /* Hover states - Cannot be done with inline styles */
                .save-modal-close-btn:hover {
                    background: ${theme.hover} !important;
                    color: ${theme.textPrimary} !important;
                }
                
                .title-input:focus {
                    border-color: ${theme.primary} !important;
                }
                
                .new-folder-btn:hover {
                    background: ${theme.hover} !important;
                }
                
                .folder-item:hover {
                    background: ${theme.hover} !important;
                }
                
                .folder-item.selected:hover {
                    background: ${theme.selectedHover} !important;
                }
                
                .save-modal-btn-cancel:hover {
                    background: ${theme.secondaryHover} !important;
                }
                
                .save-modal-btn-save:hover:not(:disabled) {
                    background: ${theme.primaryHover} !important;
                }
                
                .save-modal-btn-save:disabled {
                    background: ${theme.borderLight} !important;
                    color: ${theme.textMuted} !important;
                    cursor: not-allowed;
                    opacity: 0.8;
                }
                
                
                .folder-item:not(.selected):hover {
                    background: var(--gray-100) !important;
                }
                
                .folder-item:hover .item-actions {
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                
                .folder-add-btn:hover {
                    background: ${theme.primaryHover} !important;
                    color: ${theme.primaryForeground} !important;
                }
            </style>

            <div class="save-modal-header" style="${styleToString({
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '16px 20px',
            borderBottom: `1px solid ${theme.border}`
        })}">
                <h2 style="${styleToString({
            margin: '0',
            fontSize: '14px',
            fontWeight: '600',
            color: theme.textPrimary
        })}">Save Bookmark</h2>
                <button class="save-modal-close-btn" aria-label="Close" style="${styleToString({
            background: 'none',
            border: 'none',
            fontSize: '24px',
            color: theme.textSecondary,
            cursor: 'pointer',
            padding: '0',
            width: '32px',
            height: '32px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            borderRadius: '8px',
            transition: 'all 0.15s ease'
        })}">×</button>
            </div>

            <div class="save-modal-body" style="${styleToString({
            flex: '1',
            overflowY: 'auto',
            padding: '20px'
        })}">
                <!-- Title Section -->
                <div class="title-section" style="${styleToString({
            marginBottom: '20px'
        })}">
                    <label class="title-label" style="${styleToString({
            display: 'block',
            fontSize: '13px',
            fontWeight: '500',
            color: theme.textSecondary,
            marginBottom: '8px'
        })}">Title</label>
                    <input type="text" 
                           class="title-input" 
                           value="${this.escapeAttr(this.title)}"
                           maxlength="100"
                           placeholder="Enter bookmark title..."
                           style="${styleToString({
            width: '100%',
            padding: '10px 12px',
            border: `2px solid ${theme.border}`,
            borderRadius: '8px',
            fontSize: '13px',
            background: theme.surface,
            color: theme.onSurface,
            transition: 'all 0.15s ease',
            outline: 'none'
        })}">
                    <div class="title-error" style="display: none;"></div>
                </div>

                <!-- Folder Section -->
                <div class="folder-section" style="${styleToString({
            marginBottom: '20px'
        })}">
                    <div class="folder-header" style="${styleToString({
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            marginBottom: '8px'
        })}">
                        <span class="folder-label" style="${styleToString({
            fontSize: '13px',
            fontWeight: '500',
            color: theme.textSecondary
        })}">Folder</span>
                        <button class="new-folder-btn" title="New Folder" style="${styleToString({
            background: 'transparent',
            color: theme.primary,
            border: 'none',
            padding: '8px',
            borderRadius: '8px',
            fontSize: '14px',
            cursor: 'pointer',
            transition: 'background 0.15s ease',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        })}">${Icons.folderPlus}</button>
                    </div>
                    <div class="folder-tree-container" style="${styleToString({
            border: `1px solid ${theme.border}`,
            borderRadius: '8px',
            height: '300px',
            overflowY: 'auto',
            fontSize: '14px',
            background: theme.hover
        })}">
                        <div class="folder-tree-body" style="padding: 8px 0;">
                            <div class="folder-empty" style="${styleToString({
            padding: '40px 20px',
            textAlign: 'center',
            color: theme.textMuted
        })}">
                                <div class="folder-empty-icon" style="font-size: 48px; margin-bottom: 12px;">${Icons.folder}</div>
                                <div class="folder-empty-text" style="font-size: 13px;">Loading folders...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="save-modal-footer" style="${styleToString({
            display: 'flex',
            gap: '8px',
            justifyContent: 'flex-end',
            padding: '16px 20px',
            borderTop: `1px solid ${theme.border}`
        })}">
                <button class="save-modal-btn save-modal-btn-cancel" style="${styleToString({
            padding: '8px 16px',
            borderRadius: '8px',
            fontSize: '13px',
            fontWeight: '600',
            cursor: 'pointer',
            transition: 'all 0.15s ease',
            border: 'none',
            background: theme.secondary,
            color: theme.secondaryForeground
        })}">Cancel</button>
                <button class="save-modal-btn save-modal-btn-save" disabled style="${styleToString({
            padding: '8px 16px',
            borderRadius: '8px',
            fontSize: '13px',
            fontWeight: '600',
            cursor: 'pointer',
            transition: 'all 0.15s ease',
            border: 'none',
            background: theme.primary,
            color: theme.primaryForeground
        })}">Save</button>
            </div>
        `;

        this.bindEvents(modal);

        return modal;
    }

    /**
     * Bind event listeners
     */
    private bindEvents(modal: HTMLElement): void {
        // Get signal from AbortController for automatic cleanup
        const signal = this.abortController?.signal;

        // Close button
        const closeBtn = modal.querySelector('.save-modal-close-btn');
        closeBtn?.addEventListener('click', () => this.hide(), { signal });

        // Cancel button
        const cancelBtn = modal.querySelector('.save-modal-btn-cancel');
        cancelBtn?.addEventListener('click', () => this.hide(), { signal });

        // Save button
        const saveBtn = modal.querySelector('.save-modal-btn-save');
        saveBtn?.addEventListener('click', () => this.handleSave(), { signal });

        // Title input
        const titleInput = modal.querySelector('.title-input') as HTMLInputElement;
        titleInput?.addEventListener('input', (e) => this.handleTitleInput(e), { signal });

        // New Folder button
        const newFolderBtn = modal.querySelector('.new-folder-btn');
        newFolderBtn?.addEventListener('click', () => this.showCreateRootFolderInput(), { signal });
    }

    /**
     * Handle title input with validation
     */
    private handleTitleInput(e: Event): void {
        const input = e.target as HTMLInputElement;
        this.title = input.value;

        const validation = this.validateTitle(this.title);
        this.titleValid = validation.valid;

        const errorDiv = this.modal?.querySelector('.title-error');
        if (!errorDiv) return;

        if (!validation.valid) {
            input.classList.add('error');
            errorDiv.textContent = validation.error!;
            errorDiv.classList.add('visible');
        } else {
            input.classList.remove('error');
            errorDiv.classList.remove('visible');
        }

        this.updateSaveButtonState();
    }

    /**
     * Validate title
     */
    private validateTitle(title: string): { valid: boolean; error?: string } {
        if (!title || title.trim().length === 0) {
            return { valid: false, error: 'Title is required' };
        }
        if (title.length > 100) {
            return { valid: false, error: `Title too long (${title.length}/100)` };
        }
        return { valid: true };
    }

    /**
     * Expand path to folder (auto-expand parent folders)
     */
    private expandPathToFolder(path: string): void {
        const segments = path.split('/');
        let currentPath = '';

        for (const segment of segments) {
            currentPath = currentPath ? `${currentPath}/${segment}` : segment;
            this.expandedPaths.add(currentPath);
        }
    }

    /**
     * Render folder tree
     */
    private renderFolderTree(): void {
        if (!this.modal) return;

        const treeBody = this.modal.querySelector('.folder-tree-body');
        if (!treeBody) return;

        // Build tree structure
        const tree = TreeBuilder.buildTree(this.folders, [], new Set<string>(), null);

        if (tree.length === 0) {
            treeBody.innerHTML = `
                <div class="folder-empty">
                    <div class="folder-empty-icon">${Icons.folder}</div>
                    <div class="folder-empty-text">No folders yet. Create one to get started!</div>
                </div>
            `;
            return;
        }

        // Render tree nodes
        treeBody.innerHTML = this.renderTreeNodes(tree, 0);

        // Bind folder click handlers
        this.bindFolderClickHandlers();

        // Scroll to selected folder
        this.scrollToSelected();
    }

    /**
     * Render tree nodes recursively
     */
    private renderTreeNodes(nodes: FolderTreeNode[], depth: number): string {
        const theme = getTheme();

        return nodes.map(node => {
            const isExpanded = this.expandedPaths.has(node.folder.path);
            const isSelected = node.folder.path === this.selectedPath;
            const icon = isExpanded ? Icons.folderOpen : Icons.folder;
            const indent = depth * 20;
            // Show + button if folder can have subfolders (depth < MAX_DEPTH - 1)
            const showAddButton = depth < PathUtils.MAX_DEPTH - 1;

            // Removed folder count display per user request

            let html = `
                <div class="folder-item ${isSelected ? 'selected' : ''}"
                     data-path="${this.escapeAttr(node.folder.path)}"
                     data-depth="${depth}"
                     data-selected="${isSelected}"
                     style="display: flex; align-items: center; min-height: 36px; padding: var(--space-2) var(--space-3) var(--space-2) ${indent + 12}px; cursor: pointer; border-bottom: 1.5px solid var(--gray-300); transition: all var(--duration-fast) var(--ease-out); position: relative; border-radius: var(--radius-small); ${isSelected ? 'background: var(--primary-50); border-left: 3px solid var(--primary-600);' : ''}">
                    <span class="folder-toggle" data-path="${this.escapeAttr(node.folder.path)}" aria-label="Toggle folder" style="${styleToString({
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                width: '16px',
                height: '16px',
                marginRight: '4px',
                fontSize: '10px',
                color: theme.textSecondary,
                cursor: 'pointer',
                userSelect: 'none',
                flexShrink: '0',
                transition: 'transform 150ms ease',
                transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'
            })}">▶</span>
                    <span class="folder-icon" style="${styleToString({
                marginRight: '8px',
                fontSize: '16px',
                flexShrink: '0'
            })}">${icon}</span>
                    <span class="folder-name" style="${styleToString({
                flex: '1',
                fontSize: '13px',
                fontWeight: '500',
                color: theme.textPrimary,
                overflow: 'hidden',
                textOverflow: 'ellipsis',
                whiteSpace: 'nowrap',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
            })}">${this.escapeHtml(node.folder.name)}</span>
                    ${isSelected ? `<span class="folder-check" style="${styleToString({
                color: theme.selectedAccent,
                fontSize: '16px',
                fontWeight: '600',
                marginLeft: '8px',
                flexShrink: '0'
            })}">✓</span>` : ''}
                    <div class="item-actions" style="${styleToString({
                display: 'flex',
                gap: '4px',
                marginLeft: '8px',
                opacity: '0',
                visibility: 'hidden',
                transition: 'all 150ms ease'
            })}">
                        ${showAddButton ? `<button class="action-btn folder-add-btn" data-parent="${this.escapeAttr(node.folder.path)}" title="Create subfolder" style="${styleToString({
                background: 'transparent',
                border: 'none',
                color: theme.textSecondary,
                cursor: 'pointer',
                padding: '4px',
                borderRadius: '4px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '14px',
                transition: 'all 150ms ease'
            })}">${Icons.plus}</button>` : ''}
                    </div>
                </div>
            `;

            // Render children if expanded
            if (isExpanded && node.children.length > 0) {
                html += this.renderTreeNodes(node.children, depth + 1);
            }

            return html;
        }).join('');
    }

    /**
     * Bind folder click handlers
     */
    private bindFolderClickHandlers(): void {
        if (!this.modal) return;

        // Bind toggle buttons
        const toggleBtns = this.modal.querySelectorAll('.folder-toggle');
        toggleBtns.forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const path = (toggle as HTMLElement).dataset.path!;

                // Toggle expansion state
                if (this.expandedPaths.has(path)) {
                    this.expandedPaths.delete(path);
                } else {
                    this.expandedPaths.add(path);
                }

                // Re-render tree to update toggle icon
                this.renderFolderTree();
            });
        });

        const folderItems = this.modal.querySelectorAll('.folder-item');
        folderItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const path = (item as HTMLElement).dataset.path!;
                this.handleFolderClick(path);
            });
        });

        // Bind add subfolder buttons
        const addBtns = this.modal.querySelectorAll('.folder-add-btn');
        addBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const parentPath = (btn as HTMLElement).dataset.parent!;
                this.showCreateSubfolderInput(parentPath);
            });
        });
    }

    /**
     * Handle folder click
     */
    private handleFolderClick(path: string): void {
        // Toggle expansion
        if (this.expandedPaths.has(path)) {
            this.expandedPaths.delete(path);
        } else {
            this.expandedPaths.add(path);
        }

        // Select folder
        this.selectedPath = path;

        // Re-render tree
        this.renderFolderTree();

        // Update button state based on mode
        if (this.currentMode === 'folder-select') {
            // Enable Move button in folder-select mode
            const moveBtn = this.modal?.querySelector('.save-modal-btn-save') as HTMLButtonElement;
            if (moveBtn) {
                moveBtn.disabled = false;
            }
        } else {
            // Update Save button in create/edit mode
            this.updateSaveButtonState();
        }

        logger.debug(`[BookmarkSaveModal] Folder clicked: ${path}`);
    }

    /**
     * Scroll to selected folder
     */
    private scrollToSelected(): void {
        if (!this.modal) return;

        const selectedItem = this.modal.querySelector('.folder-item.selected');
        if (selectedItem) {
            selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    /**
     * Show create root folder input (placeholder for T3.1)
     */
    private showCreateRootFolderInput(): void {
        // TODO: Implement in T3.1
        const name = prompt('Enter folder name:');
        if (!name) return;

        this.createFolder(name, null);
    }

    /**
     * Show create subfolder input (placeholder for T3.3)
     */
    private showCreateSubfolderInput(parentPath: string): void {
        // TODO: Implement in T3.3
        const name = prompt('Enter folder name:');
        if (!name) return;
        this.createFolder(name, parentPath);
    }

    /**
     * Show simple notification (for BookmarkSaveModal errors)
     * Uses browser alert as fallback since this modal is not in Shadow DOM
     */
    private showSimpleNotification(_type: 'error' | 'warning' | 'info', message: string): void {
        // For now, use alert as it's simple and works everywhere
        // TODO: Consider creating a lightweight toast notification
        alert(message);
    }

    /**
     * Create folder
     */
    private async createFolder(name: string, parentPath: string | null): Promise<void> {
        // Validate name
        if (name.length > 50) {
            this.showSimpleNotification('error', 'Folder name too long (max 50 characters)');
            return;
        }

        if (name.includes('/')) {
            this.showSimpleNotification('error', 'Folder name cannot contain "/"');
            return;
        }

        const newPath = parentPath ? `${parentPath}/${name}` : name;

        // Check depth limit (max 4 levels: a/b/c/d, not a/b/c/d/e)
        const depth = newPath.split('/').length;
        if (depth > PathUtils.MAX_DEPTH) {
            this.showSimpleNotification('error', `Maximum folder depth is ${PathUtils.MAX_DEPTH} levels (e.g., Work/Projects/AI/ChatGPT)`);
            return;
        }

        const exists = this.folders.find(f => f.path === newPath);
        if (exists) {
            this.showSimpleNotification('error', `Folder "${name}" already exists`);
            return;
        }

        try {
            await FolderStorage.create(newPath);
            logger.info(`[BookmarkSaveModal] Created folder: ${newPath}`);

            // Reload folders
            this.folders = await FolderStorage.getAll();

            // Auto-select new folder and keep parent expanded
            this.selectedPath = newPath;
            // Keep parent folder expanded (don't collapse it)
            if (parentPath) {
                this.expandedPaths.add(parentPath);
            }
            this.expandPathToFolder(newPath);

            // Re-render
            this.renderFolderTree();
            this.updateSaveButtonState();
        } catch (error) {
            logger.error('[BookmarkSaveModal] Failed to create folder:', error);
            this.showSimpleNotification('error', `Failed to create folder: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }

    /**
     * Handle save action
     */
    private handleSave(): void {
        if (!this.titleValid || !this.selectedPath || !this.onSave) return;

        logger.info(`[BookmarkSaveModal] Saving: "${this.title}" to "${this.selectedPath}"`);
        this.onSave(this.title, this.selectedPath);
        this.hide();
    }

    /**
     * Escape HTML
     */
    private escapeHtml(text: string): string {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Escape attribute
     */
    private escapeAttr(text: string): string {
        return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    /**
     * Show folder selection mode (for batch move)
     * Returns: selected folder path, or undefined if cancelled
     */
    private showFolderSelectMode(options: {
        bookmarkCount?: number;
    }): Promise<string | null | undefined> {
        return new Promise(async (resolve) => {
            const bookmarkCount = options.bookmarkCount || 0;

            // Load folders
            this.folders = await FolderStorage.getAll();
            this.selectedPath = null;

            // Create overlay
            this.overlay = document.createElement('div');
            this.overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);  /* Keep for overlay */
                backdrop-filter: blur(4px);
                z-index: 2147483647;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s ease-out;
            `;

            // Create modal with EXACT SAME structure as bookmark save modal
            // Create modal with EXACT SAME structure as bookmark save modal
            const theme = getTheme(); // Move theme initialization up

            const modal = document.createElement('div');
            modal.className = 'bookmark-save-modal';
            // NOTE: background is controlled by CSS (html.dark) to support dark mode
            modal.style.cssText = `
                position: relative;
                width: 90%;
                max-width: 550px;
                max-height: 85vh;
                border-radius: ${theme.radius};
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                display: flex;
                flex-direction: column;
                animation: slideIn 0.2s ease-out;
            `;

            // Stop propagation on modal content
            modal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            modal.innerHTML = `
                <style>
                    /* Minimal CSS - Same as createModal() */
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-20px) scale(0.95);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }

                    .bookmark-save-modal * {
                        box-sizing: border-box;
                    }

                    /* Important: Force background color */
                    .bookmark-save-modal {
                        background: ${theme.surface} !important;
                    }
                    
                    /* Hover states */
                    .folder-item:hover {
                        background: ${theme.hover} !important;
                    }
                    
                    .folder-item.selected {
                        background: ${theme.selected} !important;
                        box-shadow: inset 3px 0 0 ${theme.selectedAccent} !important;
                    }
                    
                    .folder-item.selected:hover {
                        background: ${theme.selectedHover} !important;
                    }
                    
                    /* Action buttons - show on hover */
                    .folder-item:hover .item-actions {
                        opacity: 1 !important;
                        visibility: visible !important;
                    }
                    
                    .action-btn:hover {
                        background: rgba(255, 255, 255, 0.1) !important;
                    }
                    
                    .action-btn.delete-folder:hover {
                        background: ${theme.danger} !important;
                        color: white !important;
                    }
                    
                    .save-modal-close-btn:hover {
                        background: ${theme.hover} !important;
                        color: ${theme.textPrimary} !important;
                    }
                    
                    .folder-item:hover {
                        background: ${theme.hover} !important;
                    }
                    
                    .folder-item.selected:hover {
                        background: ${theme.selectedHover} !important;
                    }
                    
                    .save-modal-btn-cancel:hover {
                        background: ${theme.borderLight} !important;
                    }
                    
                    .save-modal-btn-save:hover:not(:disabled) {
                        background: ${theme.primaryHover} !important;
                    }
                    
                    .save-modal-btn-save:disabled {
                        background: ${theme.textMuted} !important;
                        cursor: not-allowed;
                        opacity: 0.6;
                    }
                    
                    .folder-item:hover .folder-add-btn {
                        opacity: 1 !important;
                        visibility: visible !important;
                    }
                    
                    .folder-add-btn:hover {
                        background: ${theme.primaryHover} !important;
                        color: ${theme.primaryForeground} !important;
                    }
                </style>

                <div class="save-modal-header" style="${styleToString({
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                padding: '16px 20px',
                borderBottom: `1px solid ${theme.border}`
            })}">
                    <h2 style="${styleToString({
                margin: '0',
                fontSize: '14px',
                fontWeight: '600',
                color: theme.textPrimary
            })}">Move Bookmarks to Folder</h2>
                    <button class="save-modal-close-btn" aria-label="Close" style="${styleToString({
                background: 'none',
                border: 'none',
                fontSize: '24px',
                color: theme.textSecondary,
                cursor: 'pointer',
                padding: '0',
                width: '32px',
                height: '32px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                borderRadius: '8px',
                transition: 'all 0.15s ease'
            })}">×</button>
                </div>

                <div class="save-modal-body" style="${styleToString({
                flex: '1',
                overflowY: 'auto',
                padding: '20px'
            })}">
                    <!-- Info Section -->
                    <div class="move-info" style="${styleToString({
                display: 'flex',
                alignItems: 'center',
                padding: '12px 16px',
                background: theme.infoSurface,
                border: `1px solid ${theme.infoBorder}`,
                borderRadius: '8px',
                marginBottom: '16px',
                fontSize: '14px',
                color: theme.textPrimary
            })}">
                        <span class="move-info-text" style="display: flex; align-items: center; gap: 8px;">
                            <span style="flex-shrink: 0; color: ${theme.primary};">${Icons.alertTriangle}</span>
                            <span style="font-size: 12px; color: ${theme.textPrimary}; font-weight: 500;">Moving ${bookmarkCount} bookmark${bookmarkCount > 1 ? 's' : ''}</span>
                        </span>
                    </div>

                    <!-- Folder Section -->
                    <div class="folder-section" style="${styleToString({
                marginBottom: '20px'
            })}">
                        <div class="folder-header" style="${styleToString({
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                marginBottom: '8px'
            })}">
                            <span class="folder-label" style="${styleToString({
                fontSize: '13px',
                fontWeight: '500',
                color: theme.textSecondary
            })}">Select Destination Folder</span>
                        </div>
                        <div class="folder-tree-container" style="${styleToString({
                border: `1px solid ${theme.border}`,
                borderRadius: '8px',
                height: '300px',
                overflowY: 'auto',
                fontSize: '14px',
                background: theme.hover
            })}">
                            <div class="folder-tree-body" style="padding: 8px 0;">
                                <div class="folder-empty" style="${styleToString({
                padding: '40px 20px',
                textAlign: 'center',
                color: theme.textMuted
            })}">
                                    <div class="folder-empty-icon" style="font-size: 48px; margin-bottom: 12px;">${Icons.folder}</div>
                                    <div class="folder-empty-text" style="font-size: 13px;">Loading folders...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="save-modal-footer" style="${styleToString({
                display: 'flex',
                gap: '8px',
                justifyContent: 'flex-end',
                padding: '16px 20px',
                borderTop: `1px solid ${theme.border}`
            })}">

                    <button class="save-modal-btn save-modal-btn-cancel" style="${styleToString({
                padding: '8px 16px',
                borderRadius: '8px',
                fontSize: '13px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.15s ease',
                border: 'none',
                background: theme.secondary,
                color: theme.secondaryForeground
            })}">Cancel</button>
                    <button class="save-modal-btn save-modal-btn-save" disabled style="${styleToString({
                padding: '8px 16px',
                borderRadius: '8px',
                fontSize: '13px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.15s ease',
                border: 'none',
                background: theme.primary,
                color: theme.primaryForeground
            })}">Move</button>
                </div>
            `;

            this.modal = modal;
            this.overlay.appendChild(modal);
            document.body.appendChild(this.overlay);

            // Render folder tree using EXISTING method
            this.renderFolderTree();

            // Event handlers
            const closeBtn = modal.querySelector('.save-modal-close-btn') as HTMLButtonElement;
            const cancelBtn = modal.querySelector('.save-modal-btn-cancel') as HTMLButtonElement;
            const moveBtn = modal.querySelector('.save-modal-btn-save') as HTMLButtonElement;

            closeBtn.addEventListener('click', () => {
                this.hide();
                resolve(undefined);
            });

            cancelBtn.addEventListener('click', () => {
                this.hide();
                resolve(undefined);
            });

            moveBtn.addEventListener('click', () => {
                const selected = this.selectedPath;
                this.hide();
                resolve(selected);
            });

            // Click outside to close
            this.overlay.addEventListener('click', (e) => {
                if (e.target === this.overlay) {
                    this.hide();
                    resolve(undefined);
                }
            });

            // ESC key to close
            this.escKeyHandler = (e: KeyboardEvent) => {
                if (e.key === 'Escape') {
                    this.hide();
                    document.removeEventListener('keydown', this.escKeyHandler!);
                    resolve(undefined);
                }
            };
            document.addEventListener('keydown', this.escKeyHandler);
        });
    }
}

